---
- name: Получить статус каталога для установленных плагинов
  ansible.builtin.stat:
    path: '{{ _zi_home_dir }}/plugins'
  register: r__plugins_dir

- name: Если каталог для установленных плагинов существует
  block:

  - name: Получить список установленных плагинов
    ansible.builtin.find:
      paths: '{{ _zi_home_dir }}/plugins'
      file_type: directory
      recurse: no
    register: r__installed_plugins

  - name: Получить нормализованный список установленных плагинов
    ansible.builtin.set_fact:
      _installed_plugin_list: "{{ r__installed_plugins.files | map(attribute='path') | map('basename') | select('match', '^(?!_local).*$') | list }}"

  - name: Получить список плагинов, указанных в конфигурации
    ansible.builtin.set_fact:
      _config_plugin_list: "{{ plugins | map(attribute='name') | map('replace', '/', '---') | list }}"

  - name: Получить список плагинов для удаления
    ansible.builtin.set_fact:
      _remove_plugin_list: '{{ _installed_plugin_list | difference(_config_plugin_list) }}'

  - name: Удалить плагины, не представленные в конфигурации
    ansible.builtin.file:
      path: '{{ _zi_home_dir }}/plugins/{{ item }}'
      state: absent
    loop: '{{ _remove_plugin_list }}'
    when: _remove_plugin_list | length > 0

  when:
    - r__plugins_dir.stat.exists
    - r__plugins_dir.stat.isdir
